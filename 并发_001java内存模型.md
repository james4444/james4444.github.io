# 并发编程

## java 内存模型

java虚拟机规范中试图定义一种java内存模型，来屏蔽掉各种硬件和操作系统的内存访问差异，以实现让java程序在各种平台下，都能达到一致的内存访问结果。

java 内存模型描述了在多线程中，哪些行为是合法的，以及线程之间如何通过内存进行交互。它描述了程序中的变量和从内存或者寄存器获取或存储他们底层细节之间的关系。java内存模型规范了JVM如何提供按需禁用缓存和编译优化的方法。

java内存模型的主要目标是定义程序中各个变量的访问规则，即在虚拟机中将变量存储到内存和在内存中取出变量这样的底层细节。此处的变量主要指静态变量，实例字段和构成数组对象的元素，不包含局部变量和方法参数，因为后者是线程私有的，不会被共享，不存在竞争问题。

java内存模型定义了所有的变量都存储在主存中，每条线程还有自己的工作内存，线程的工作内存保存了被该线程使用到的变量的主内存副本。不同线程之间的变量共享必须要通过主内存。不同线程之间的工作内存无法互相访问

方法包括：volatile、synchronized、final关键字，以及六项happens-before规则

关于主内存与工作内存之间具体的交互协议，java内存模型中定义了8中操作来完成

* lock 锁定，主内存中完成，他把一个变量标识为一条线程独占的状态

* unlock 解锁，主内存中完成，解锁后，可被其他线程锁定

* read 读取，主内存中完成，他把一个变量的值从主内存传输到线程的工作内存

* load 载入，工作内存中完成，把工作内存中得到的变量放入到工作内存的变量副本中

* use 使用，工作内存中完成，把变量的值传递给执行引擎
 
* assign 赋值，工作内存中完成，把从执行引擎中接收到的值赋值给工作内存中的变量

* store 存储 工作内存中完成，把工作内存中的值传递到主内存中

* write 写入，把store中的变量写入到主内存中

